rule win_kivars_auto {

    meta:
        author = "Felix Bilstein - yara-signator at cocacoding dot com"
        date = "2023-03-28"
        version = "1"
        description = "Detects win.kivars."
        info = "autogenerated rule brought to you by yara-signator"
        tool = "yara-signator v0.6.0"
        signator_config = "callsandjumps;datarefs;binvalue"
        malpedia_reference = "https://malpedia.caad.fkie.fraunhofer.de/details/win.kivars"
        malpedia_rule_date = "20230328"
        malpedia_hash = "9d2d75cef573c1c2d861f5197df8f563b05a305d"
        malpedia_version = "20230407"
        malpedia_license = "CC BY-SA 4.0"
        malpedia_sharing = "TLP:WHITE"

    /* DISCLAIMER
     * The strings used in this rule have been automatically selected from the
     * disassembly of memory dumps and unpacked files, using YARA-Signator.
     * The code and documentation is published here:
     * https://github.com/fxb-cocacoding/yara-signator
     * As Malpedia is used as data source, please note that for a given
     * number of families, only single samples are documented.
     * This likely impacts the degree of generalization these rules will offer.
     * Take the described generation method also into consideration when you
     * apply the rules in your use cases and assign them confidence levels.
     */


    strings:
        $sequence_0 = { 488d8c24bc000000 ff15???????? 488b8c2468020000 488bd1 }
            // n = 4, score = 200
            //   488d8c24bc000000     | lea                 eax, [esp + 0x84]
            //   ff15????????         |                     
            //   488b8c2468020000     | dec                 eax
            //   488bd1               | mov                 ecx, eax

        $sequence_1 = { 488b842470080000 c6400301 488b842488080000 488b4018 488b00 }
            // n = 5, score = 200
            //   488b842470080000     | dec                 eax
            //   c6400301             | cmp                 dword ptr [esp + 0x30], eax
            //   488b842488080000     | jne                 0x70
            //   488b4018             | cmp                 dword ptr [esp + 0x38], 0
            //   488b00               | dec                 eax

        $sequence_2 = { 52 e8???????? 8b442420 8b4c2428 57 }
            // n = 5, score = 200
            //   52                   | mov                 al, byte ptr [esp + eax + 0x10]
            //   e8????????           |                     
            //   8b442420             | add                 ebp, 4
            //   8b4c2428             | mov                 dl, byte ptr [esp + edx + 0x10]
            //   57                   | mov                 byte ptr [ecx], al

        $sequence_3 = { c644242255 c64424236e c64424246d c644242561 c644242670 c644242756 }
            // n = 6, score = 200
            //   c644242255           | cmp                 eax, esi
            //   c64424236e           | mov                 dword ptr [esp + 0x34], esi
            //   c64424246d           | jbe                 0x17d
            //   c644242561           | mov                 ecx, 0x41
            //   c644242670           | mov                 byte ptr [esi + 0x100], cl
            //   c644242756           | mov                 byte ptr [esi + 0x101], cl

        $sequence_4 = { ff12 8b442440 89742438 3bc6 89742434 0f8667010000 b941000000 }
            // n = 7, score = 200
            //   ff12                 | mov                 eax, dword ptr [eax]
            //   8b442440             | dec                 eax
            //   89742438             | lea                 ecx, [esp + 0xbc]
            //   3bc6                 | dec                 eax
            //   89742434             | mov                 ecx, dword ptr [esp + 0x268]
            //   0f8667010000         | dec                 eax
            //   b941000000           | mov                 edx, ecx

        $sequence_5 = { ff12 53 e8???????? 8b4c2418 }
            // n = 4, score = 200
            //   ff12                 | push                edi
            //   53                   | mov                 ecx, esi
            //   e8????????           |                     
            //   8b4c2418             | lea                 esi, [esp + 0x190]

        $sequence_6 = { 89442438 488b442428 4839442430 7564 837c243800 }
            // n = 5, score = 200
            //   89442438             | dec                 eax
            //   488b442428           | mov                 edi, eax
            //   4839442430           | mov                 byte ptr [esp + 0x119b], 0x2e
            //   7564                 | mov                 byte ptr [esp + 0x119c], 0xbe
            //   837c243800           | mov                 byte ptr [esp + 0x119d], 0x2d

        $sequence_7 = { 888e00010000 888e01010000 32db 884c2418 }
            // n = 4, score = 200
            //   888e00010000         | mov                 dword ptr [esp + 0x124], eax
            //   888e01010000         | mov                 eax, dword ptr [esp + 0x240]
            //   32db                 | mov                 ecx, dword ptr [esp + 0x124]
            //   884c2418             | add                 ecx, eax

        $sequence_8 = { 8955cc 8955d4 85d2 7446 8bcf }
            // n = 5, score = 200
            //   8955cc               | xor                 bl, bl
            //   8955d4               | mov                 byte ptr [esp + 0x18], cl
            //   85d2                 | push                edx
            //   7446                 | mov                 eax, dword ptr [esp + 0x20]
            //   8bcf                 | mov                 ecx, dword ptr [esp + 0x28]

        $sequence_9 = { 488d842484000000 488bc8 ff15???????? 83f802 7e27 }
            // n = 5, score = 200
            //   488d842484000000     | mov                 byte ptr [esp + 0x119e], 0x86
            //   488bc8               | mov                 dword ptr [esp + 0x38], eax
            //   ff15????????         |                     
            //   83f802               | dec                 eax
            //   7e27                 | mov                 eax, dword ptr [esp + 0x28]

        $sequence_10 = { 48898424c0010000 488d442430 488d0deb3a0000 488bf8 }
            // n = 4, score = 200
            //   48898424c0010000     | dec                 eax
            //   488d442430           | imul                eax, eax, 0x2c
            //   488d0deb3a0000       | dec                 eax
            //   488bf8               | mov                 dword ptr [esp + 0x1c0], eax

        $sequence_11 = { 8a440410 83c504 8a541410 8801 b03d 885101 }
            // n = 6, score = 200
            //   8a440410             | mov                 byte ptr [eax + 3], 1
            //   83c504               | dec                 eax
            //   8a541410             | mov                 eax, dword ptr [esp + 0x888]
            //   8801                 | dec                 eax
            //   b03d                 | mov                 eax, dword ptr [eax + 0x18]
            //   885101               | dec                 eax

        $sequence_12 = { c784245402000001000000 33c0 83f801 0f841a010000 83bc245802000000 }
            // n = 5, score = 200
            //   c784245402000001000000     | mov    dword ptr [esp + 0x254], 1
            //   33c0                 | xor                 eax, eax
            //   83f801               | cmp                 eax, 1
            //   0f841a010000         | je                  0x120
            //   83bc245802000000     | cmp                 dword ptr [esp + 0x258], 0

        $sequence_13 = { c684249b1100002e c684249c110000be c684249d1100002d c684249e11000086 }
            // n = 4, score = 200
            //   c684249b1100002e     | dec                 eax
            //   c684249c110000be     | lea                 eax, [esp + 0x30]
            //   c684249d1100002d     | dec                 eax
            //   c684249e11000086     | lea                 ecx, [0x3aeb]

        $sequence_14 = { 8bce 8db42490010000 8d3c10 8bd1 c1e902 }
            // n = 5, score = 200
            //   8bce                 | mov                 al, 0x3d
            //   8db42490010000       | mov                 byte ptr [ecx + 1], dl
            //   8d3c10               | call                dword ptr [edx]
            //   8bd1                 | mov                 eax, dword ptr [esp + 0x40]
            //   c1e902               | mov                 dword ptr [esp + 0x38], esi

        $sequence_15 = { 898424f0010000 837c243005 7c08 c744243000000000 4863442430 486bc02c }
            // n = 6, score = 200
            //   898424f0010000       | mov                 dword ptr [esp + 0x1f0], eax
            //   837c243005           | cmp                 dword ptr [esp + 0x30], 5
            //   7c08                 | jl                  0xa
            //   c744243000000000     | mov                 dword ptr [esp + 0x30], 0
            //   4863442430           | dec                 eax
            //   486bc02c             | arpl                word ptr [esp + 0x30], ax

    condition:
        7 of them and filesize < 196608
}