rule win_madmax_auto {

    meta:
        author = "Felix Bilstein - yara-signator at cocacoding dot com"
        date = "2023-03-28"
        version = "1"
        description = "Detects win.madmax."
        info = "autogenerated rule brought to you by yara-signator"
        tool = "yara-signator v0.6.0"
        signator_config = "callsandjumps;datarefs;binvalue"
        malpedia_reference = "https://malpedia.caad.fkie.fraunhofer.de/details/win.madmax"
        malpedia_rule_date = "20230328"
        malpedia_hash = "9d2d75cef573c1c2d861f5197df8f563b05a305d"
        malpedia_version = "20230407"
        malpedia_license = "CC BY-SA 4.0"
        malpedia_sharing = "TLP:WHITE"

    /* DISCLAIMER
     * The strings used in this rule have been automatically selected from the
     * disassembly of memory dumps and unpacked files, using YARA-Signator.
     * The code and documentation is published here:
     * https://github.com/fxb-cocacoding/yara-signator
     * As Malpedia is used as data source, please note that for a given
     * number of families, only single samples are documented.
     * This likely impacts the degree of generalization these rules will offer.
     * Take the described generation method also into consideration when you
     * apply the rules in your use cases and assign them confidence levels.
     */


    strings:
        $sequence_0 = { ce 98 f319fb 245f da9b35588d18 f6c327 9d }
            // n = 7, score = 100
            //   ce                   | into                
            //   98                   | cwde                
            //   f319fb               | sbb                 ebx, edi
            //   245f                 | and                 al, 0x5f
            //   da9b35588d18         | ficomp              dword ptr [ebx + 0x188d5835]
            //   f6c327               | test                bl, 0x27
            //   9d                   | popfd               

        $sequence_1 = { ffc8 e647 101b 4c 15e063f6cf 8716 7d4f }
            // n = 7, score = 100
            //   ffc8                 | dec                 eax
            //   e647                 | out                 0x47, al
            //   101b                 | adc                 byte ptr [ebx], bl
            //   4c                   | dec                 esp
            //   15e063f6cf           | adc                 eax, 0xcff663e0
            //   8716                 | xchg                dword ptr [esi], edx
            //   7d4f                 | jge                 0x51

        $sequence_2 = { c58a2778b3ee bfd961caa3 fb d96a56 6e 42 0f6408 }
            // n = 7, score = 100
            //   c58a2778b3ee         | lds                 ecx, ptr [edx - 0x114c87d9]
            //   bfd961caa3           | mov                 edi, 0xa3ca61d9
            //   fb                   | sti                 
            //   d96a56               | fldcw               word ptr [edx + 0x56]
            //   6e                   | outsb               dx, byte ptr [esi]
            //   42                   | inc                 edx
            //   0f6408               | pcmpgtb             mm1, qword ptr [eax]

        $sequence_3 = { e025 26d072b7 ff4ba9 ef 1c19 ba2d4ad420 1a5cf2ea }
            // n = 7, score = 100
            //   e025                 | loopne              0x27
            //   26d072b7             | sal                 byte ptr es:[edx - 0x49], 1
            //   ff4ba9               | dec                 dword ptr [ebx - 0x57]
            //   ef                   | out                 dx, eax
            //   1c19                 | sbb                 al, 0x19
            //   ba2d4ad420           | mov                 edx, 0x20d44a2d
            //   1a5cf2ea             | sbb                 bl, byte ptr [edx + esi*8 - 0x16]

        $sequence_4 = { c9 9f d8ef 0536069e11 2f a3???????? 3f }
            // n = 7, score = 100
            //   c9                   | leave               
            //   9f                   | lahf                
            //   d8ef                 | fsubr               st(7)
            //   0536069e11           | add                 eax, 0x119e0636
            //   2f                   | das                 
            //   a3????????           |                     
            //   3f                   | aas                 

        $sequence_5 = { e79a dd702e ee 18dd 1e 2c45 d31b }
            // n = 7, score = 100
            //   e79a                 | out                 0x9a, eax
            //   dd702e               | fnsave              dword ptr [eax + 0x2e]
            //   ee                   | out                 dx, al
            //   18dd                 | sbb                 ch, bl
            //   1e                   | push                ds
            //   2c45                 | sub                 al, 0x45
            //   d31b                 | rcr                 dword ptr [ebx], cl

        $sequence_6 = { e55b aa 1f 4d a6 f745160f5bdf25 33b3292d21c5 }
            // n = 7, score = 100
            //   e55b                 | in                  eax, 0x5b
            //   aa                   | stosb               byte ptr es:[edi], al
            //   1f                   | pop                 ds
            //   4d                   | dec                 ebp
            //   a6                   | cmpsb               byte ptr [esi], byte ptr es:[edi]
            //   f745160f5bdf25       | test                dword ptr [ebp + 0x16], 0x25df5b0f
            //   33b3292d21c5         | xor                 esi, dword ptr [ebx - 0x3aded2d7]

        $sequence_7 = { f605????????63 750b 31c3 0f853192525e 4a b302 9d }
            // n = 7, score = 100
            //   f605????????63       |                     
            //   750b                 | jne                 0xd
            //   31c3                 | xor                 ebx, eax
            //   0f853192525e         | jne                 0x5e529237
            //   4a                   | dec                 edx
            //   b302                 | mov                 bl, 2
            //   9d                   | popfd               

        $sequence_8 = { f2bacfdc7a88 a7 c82fe12e fc 0d9d0e6e28 095aaa c46aac }
            // n = 7, score = 100
            //   f2bacfdc7a88         | mov                 edx, 0x887adccf
            //   a7                   | cmpsd               dword ptr [esi], dword ptr es:[edi]
            //   c82fe12e             | enter               -0x1ed1, 0x2e
            //   fc                   | cld                 
            //   0d9d0e6e28           | or                  eax, 0x286e0e9d
            //   095aaa               | or                  dword ptr [edx - 0x56], ebx
            //   c46aac               | les                 ebp, ptr [edx - 0x54]

        $sequence_9 = { c641823e 6442 af c53f a0???????? b5ce 27 }
            // n = 7, score = 100
            //   c641823e             | mov                 byte ptr [ecx - 0x7e], 0x3e
            //   6442                 | inc                 edx
            //   af                   | scasd               eax, dword ptr es:[edi]
            //   c53f                 | lds                 edi, ptr [edi]
            //   a0????????           |                     
            //   b5ce                 | mov                 ch, 0xce
            //   27                   | daa                 

    condition:
        7 of them and filesize < 3227648
}