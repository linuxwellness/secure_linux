rule win_cargobay_auto {

    meta:
        author = "Felix Bilstein - yara-signator at cocacoding dot com"
        date = "2023-03-28"
        version = "1"
        description = "Detects win.cargobay."
        info = "autogenerated rule brought to you by yara-signator"
        tool = "yara-signator v0.6.0"
        signator_config = "callsandjumps;datarefs;binvalue"
        malpedia_reference = "https://malpedia.caad.fkie.fraunhofer.de/details/win.cargobay"
        malpedia_rule_date = "20230328"
        malpedia_hash = "9d2d75cef573c1c2d861f5197df8f563b05a305d"
        malpedia_version = "20230407"
        malpedia_license = "CC BY-SA 4.0"
        malpedia_sharing = "TLP:WHITE"

    /* DISCLAIMER
     * The strings used in this rule have been automatically selected from the
     * disassembly of memory dumps and unpacked files, using YARA-Signator.
     * The code and documentation is published here:
     * https://github.com/fxb-cocacoding/yara-signator
     * As Malpedia is used as data source, please note that for a given
     * number of families, only single samples are documented.
     * This likely impacts the degree of generalization these rules will offer.
     * Take the described generation method also into consideration when you
     * apply the rules in your use cases and assign them confidence levels.
     */


    strings:
        $sequence_0 = { 8b742468 448b6c2464 e9???????? 488dbc2410050000 4889f9 e8???????? 488d9c2480030000 }
            // n = 7, score = 100
            //   8b742468             | dec                 eax
            //   448b6c2464           | mov                 ebp, dword ptr [esp + 0x38]
            //   e9????????           |                     
            //   488dbc2410050000     | je                  0x1aa1
            //   4889f9               | cmp                 byte ptr [esp + 0x110], 0
            //   e8????????           |                     
            //   488d9c2480030000     | je                  0x1aba

        $sequence_1 = { 4889d6 4889cf 80b96601000000 7409 80bf6701000000 7519 488d5c2428 }
            // n = 7, score = 100
            //   4889d6               | mov                 esi, ecx
            //   4889cf               | dec                 ebp
            //   80b96601000000       | add                 ecx, eax
            //   7409                 | xor                 edi, edi
            //   80bf6701000000       | xor                 ecx, ecx
            //   7519                 | dec                 eax
            //   488d5c2428           | sub                 ebp, eax

        $sequence_2 = { e8???????? 4883bda000000000 488d0594a30a00 480f4485a8000000 b909000000 480f448db0000000 48898580000000 }
            // n = 7, score = 100
            //   e8????????           |                     
            //   4883bda000000000     | jae                 0x12b0
            //   488d0594a30a00       | dec                 esp
            //   480f4485a8000000     | mov                 ecx, esp
            //   b909000000           | cmp                 ax, 0xe
            //   480f448db0000000     | je                  0x12bf
            //   48898580000000       | mov                 ebp, eax

        $sequence_3 = { e9???????? 4c8bbc24f8010000 e9???????? 4885db 0f8402010000 4c8bbc24d0010000 0f108424d8010000 }
            // n = 7, score = 100
            //   e9????????           |                     
            //   4c8bbc24f8010000     | cmp                 ebx, 1
            //   e9????????           |                     
            //   4885db               | jne                 0x3dc
            //   0f8402010000         | inc                 esp
            //   4c8bbc24d0010000     | mov                 eax, esp
            //   0f108424d8010000     | inc                 cx

        $sequence_4 = { 894c2428 4889d1 48c1e920 4889ce 48894c2470 89d2 4489c9 }
            // n = 7, score = 100
            //   894c2428             | lea                 esp, [ebp + 1]
            //   4889d1               | dec                 eax
            //   48c1e920             | mov                 ecx, ebx
            //   4889ce               | dec                 eax
            //   48894c2470           | mov                 edx, ebp
            //   89d2                 | dec                 esp
            //   4489c9               | lea                 eax, [0xcb4c7]

        $sequence_5 = { 4c89642428 48897c2420 4989ff 488d5c2458 4889d9 4c89c6 4c89f5 }
            // n = 7, score = 100
            //   4c89642428           | lea                 esp, [esp + 0x78]
            //   48897c2420           | dec                 esp
            //   4989ff               | mov                 dword ptr [esp + 0x40], esp
            //   488d5c2458           | dec                 eax
            //   4889d9               | mov                 dword ptr [esp + 0x48], 1
            //   4c89c6               | dec                 eax
            //   4c89f5               | mov                 ecx, dword ptr [eax + 0x20]

        $sequence_6 = { ffd6 4983c7c8 48ffc3 4c89f1 83f803 74d0 83f801 }
            // n = 7, score = 100
            //   ffd6                 | movups              xmm0, xmmword ptr [edi + 0x38]
            //   4983c7c8             | movaps              xmmword ptr [esp + 0x70], xmm0
            //   48ffc3               | movups              xmm0, xmmword ptr [edi + 0x48]
            //   4c89f1               | movaps              xmmword ptr [esp + 0x80], xmm0
            //   83f803               | dec                 eax
            //   74d0                 | mov                 eax, dword ptr [edi + 0x58]
            //   83f801               | mov                 edi, dword ptr [eax + 3]

        $sequence_7 = { e9???????? 4d39c5 0f82e3060000 488d8de0040000 4c89f2 e8???????? 488bb5e0040000 }
            // n = 7, score = 100
            //   e9????????           |                     
            //   4d39c5               | dec                 eax
            //   0f82e3060000         | mov                 ecx, eax
            //   488d8de0040000       | test                al, al
            //   4c89f2               | je                  0xa95
            //   e8????????           |                     
            //   488bb5e0040000       | dec                 eax

        $sequence_8 = { 74c3 0fb6c3 83f87b 754b b808000000 ebb4 4c8d442430 }
            // n = 7, score = 100
            //   74c3                 | mov                 ebx, ecx
            //   0fb6c3               | dec                 esp
            //   83f87b               | mov                 ebx, ecx
            //   754b                 | dec                 eax
            //   b808000000           | shr                 ebx, 0x14
            //   ebb4                 | mov                 byte ptr [ecx + 9], bl
            //   4c8d442430           | dec                 esp

        $sequence_9 = { 89c8 41b20f 3c03 0f839afdffff e9???????? b004 4c8b642448 }
            // n = 7, score = 100
            //   89c8                 | lea                 ecx, [esp + 0x4a0]
            //   41b20f               | vmovaps             ymm0, ymmword ptr [esp + 0xa0]
            //   3c03                 | vmovaps             ymmword ptr [ecx], ymm0
            //   0f839afdffff         | dec                 eax
            //   e9????????           |                     
            //   b004                 | lea                 ebx, [esp + 0x140]
            //   4c8b642448           | dec                 eax

    condition:
        7 of them and filesize < 3432448
}