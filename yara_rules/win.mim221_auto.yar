rule win_mim221_auto {

    meta:
        author = "Felix Bilstein - yara-signator at cocacoding dot com"
        date = "2023-03-28"
        version = "1"
        description = "Detects win.mim221."
        info = "autogenerated rule brought to you by yara-signator"
        tool = "yara-signator v0.6.0"
        signator_config = "callsandjumps;datarefs;binvalue"
        malpedia_reference = "https://malpedia.caad.fkie.fraunhofer.de/details/win.mim221"
        malpedia_rule_date = "20230328"
        malpedia_hash = "9d2d75cef573c1c2d861f5197df8f563b05a305d"
        malpedia_version = "20230407"
        malpedia_license = "CC BY-SA 4.0"
        malpedia_sharing = "TLP:WHITE"

    /* DISCLAIMER
     * The strings used in this rule have been automatically selected from the
     * disassembly of memory dumps and unpacked files, using YARA-Signator.
     * The code and documentation is published here:
     * https://github.com/fxb-cocacoding/yara-signator
     * As Malpedia is used as data source, please note that for a given
     * number of families, only single samples are documented.
     * This likely impacts the degree of generalization these rules will offer.
     * Take the described generation method also into consideration when you
     * apply the rules in your use cases and assign them confidence levels.
     */


    strings:
        $sequence_0 = { 458d4765 488d8c2444030000 33d2 4889842420030000 c7842410030000f0230000 c78424180300000c000000 c784242803000000000000 }
            // n = 7, score = 100
            //   458d4765             | dec                 esp
            //   488d8c2444030000     | lea                 esp, [0x10f6c]
            //   33d2                 | mov                 edi, 1
            //   4889842420030000     | mov                 dword ptr [esp + 0x30], edi
            //   c7842410030000f0230000     | mov    dword ptr [esp + 0x78], edi
            //   c78424180300000c000000     | dec    eax
            //   c784242803000000000000     | mov    dword ptr [esp + 0x80], eax

        $sequence_1 = { 721c 498b0424 498bcc ff5008 488b38 440fb74602 488b5608 }
            // n = 7, score = 100
            //   721c                 | lea                 edx, [esp + 0x188]
            //   498b0424             | dec                 eax
            //   498bcc               | mov                 edi, eax
            //   ff5008               | dec                 eax
            //   488b38               | mov                 ecx, dword ptr [esp + 0x270]
            //   440fb74602           | dec                 eax
            //   488b5608             | mov                 ecx, eax

        $sequence_2 = { 0f82d00e0000 488b8c24d0010000 e8???????? e9???????? 66c78424d00000005b00 66c78424d20000004500 66c78424d40000005200 }
            // n = 7, score = 100
            //   0f82d00e0000         | dec                 eax
            //   488b8c24d0010000     | lea                 edx, [esp + 0x20]
            //   e8????????           |                     
            //   e9????????           |                     
            //   66c78424d00000005b00     | mov    word ptr [esp + 0x62], 0
            //   66c78424d20000004500     | dec    eax
            //   66c78424d40000005200     | lea    edx, [esp + 0x70]

        $sequence_3 = { 80784801 755d 488b01 c6404801 40886948 4c8b09 498b4110 }
            // n = 7, score = 100
            //   80784801             | lea                 edi, [ebx + 8]
            //   755d                 | dec                 eax
            //   488b01               | mov                 ebp, edx
            //   c6404801             | dec                 eax
            //   40886948             | lea                 edi, [ecx + 0x40]
            //   4c8b09               | mov                 esi, 8
            //   498b4110             | dec                 eax

        $sequence_4 = { 48837f2010 4c895f18 7203 488b1b 42c6041b00 488bc7 4883c428 }
            // n = 7, score = 100
            //   48837f2010           | mov                 dword ptr [esp + 0x7f8], ebp
            //   4c895f18             | dec                 eax
            //   7203                 | mov                 dword ptr [esp + 0x800], ebp
            //   488b1b               | mov                 dword ptr [esp + 0x808], ebx
            //   42c6041b00           | mov                 dword ptr [esp + 0x80c], 7
            //   488bc7               | mov                 edx, 0x108
            //   4883c428             | mov                 dword ptr [esp + 0x4fc], ebp

        $sequence_5 = { 66898424b4000000 66c78424b60000002800 66c78424b80000003000 66c78424ba0000007800 66c78424bc0000002500 66c78424be0000003000 66c78424c00000003800 }
            // n = 7, score = 100
            //   66898424b4000000     | inc                 ecx
            //   66c78424b60000002800     | mov    ebx, 2
            //   66c78424b80000003000     | mov    eax, 0x80802
            //   66c78424ba0000007800     | mov    dword ptr [esp + 0x14], eax
            //   66c78424bc0000002500     | inc    esp
            //   66c78424be0000003000     | lea    esi, [ecx + 0x19]
            //   66c78424c00000003800     | inc    ebp

        $sequence_6 = { 90 488d051da20200 488907 488d4f18 }
            // n = 4, score = 100
            //   90                   | cmp                 byte ptr [eax + 0x49], 0
            //   488d051da20200       | jne                 0x50f
            //   488907               | dec                 eax
            //   488d4f18             | mov                 ebx, eax

        $sequence_7 = { 498bc8 ff10 4889442460 8b05???????? 3d70170000 7304 8bdd }
            // n = 7, score = 100
            //   498bc8               | inc                 esp
            //   ff10                 | xor                 ebx, eax
            //   4889442460           | xor                 eax, edx
            //   8b05????????         |                     
            //   3d70170000           | mov                 ebp, 0xfc
            //   7304                 | inc                 ecx
            //   8bdd                 | and                 eax, esi

        $sequence_8 = { e8???????? 85c0 741c 488b8c24e8000000 8b042e 3901 750d }
            // n = 7, score = 100
            //   e8????????           |                     
            //   85c0                 | dec                 eax
            //   741c                 | lea                 ecx, [esp + 0xc0]
            //   488b8c24e8000000     | nop                 
            //   8b042e               | dec                 eax
            //   3901                 | mov                 dword ptr [esp + 0x1a8], 0xf
            //   750d                 | dec                 eax

        $sequence_9 = { 41bf00000020 41b900008200 41be80008200 898c2438070000 898c2454070000 898c2488070000 }
            // n = 6, score = 100
            //   41bf00000020         | dec                 ecx
            //   41b900008200         | mov                 dword ptr [esp + 0x20], eax
            //   41be80008200         | inc                 ebp
            //   898c2438070000       | xor                 ecx, ecx
            //   898c2454070000       | inc                 ebp
            //   898c2488070000       | xor                 eax, eax

    condition:
        7 of them and filesize < 471040
}