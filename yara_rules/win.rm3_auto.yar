rule win_rm3_auto {

    meta:
        author = "Felix Bilstein - yara-signator at cocacoding dot com"
        date = "2023-03-29"
        version = "1"
        description = "Detects win.rm3."
        info = "autogenerated rule brought to you by yara-signator"
        tool = "yara-signator v0.6.0"
        signator_config = "callsandjumps;datarefs;binvalue"
        malpedia_reference = "https://malpedia.caad.fkie.fraunhofer.de/details/win.rm3"
        malpedia_rule_date = "20230328"
        malpedia_hash = "9d2d75cef573c1c2d861f5197df8f563b05a305d"
        malpedia_version = "20230407"
        malpedia_license = "CC BY-SA 4.0"
        malpedia_sharing = "TLP:WHITE"

    /* DISCLAIMER
     * The strings used in this rule have been automatically selected from the
     * disassembly of memory dumps and unpacked files, using YARA-Signator.
     * The code and documentation is published here:
     * https://github.com/fxb-cocacoding/yara-signator
     * As Malpedia is used as data source, please note that for a given
     * number of families, only single samples are documented.
     * This likely impacts the degree of generalization these rules will offer.
     * Take the described generation method also into consideration when you
     * apply the rules in your use cases and assign them confidence levels.
     */


    strings:
        $sequence_0 = { 8b30 8931 8b7004 897104 8b4808 }
            // n = 5, score = 2300
            //   8b30                 | jne                 0x10a
            //   8931                 | dec                 eax
            //   8b7004               | test                ebp, ebp
            //   897104               | je                  0x1f
            //   8b4808               | xor                 edx, edx

        $sequence_1 = { 8d4438ff 4f f7d7 23c7 8d7c13ff 4a f7d2 }
            // n = 7, score = 2300
            //   8d4438ff             | ja                  0x24
            //   4f                   | jne                 0x1c
            //   f7d7                 | dec                 eax
            //   23c7                 | cmp                 eax, ebx
            //   8d7c13ff             | dec                 eax
            //   4a                   | mov                 esi, eax
            //   f7d2                 | je                  0x19

        $sequence_2 = { f7d0 23d0 8b460c 03c2 394508 }
            // n = 5, score = 2300
            //   f7d0                 | dec                 esp
            //   23d0                 | lea                 eax, [edi + 0xb0]
            //   8b460c               | xor                 edx, edx
            //   03c2                 | test                eax, eax
            //   394508               | mov                 ebx, eax

        $sequence_3 = { 7609 8b413c 8d5418ff eb0a 8b4138 8b5608 8d5410ff }
            // n = 7, score = 2300
            //   7609                 | dec                 eax
            //   8b413c               | mov                 ecx, ebp
            //   8d5418ff             | movzx               eax, word ptr [ecx + 6]
            //   eb0a                 | and                 dword ptr [ebp - 8], 0
            //   8b4138               | push                ebx
            //   8b5608               | mov                 dword ptr [ebp - 4], eax
            //   8d5410ff             | movzx               eax, word ptr [ecx + 0x14]

        $sequence_4 = { 394508 7303 8975f8 8b45f8 83c628 ff4dfc 85c0 }
            // n = 7, score = 2300
            //   394508               | mov                 eax, dword ptr [eax]
            //   7303                 | push                ecx
            //   8975f8               | add                 eax, edx
            //   8b45f8               | push                eax
            //   83c628               | add                 ecx, eax
            //   ff4dfc               | movzx               eax, word ptr [ecx + 6]
            //   85c0                 | and                 dword ptr [ebp - 8], 0

        $sequence_5 = { 034c240c 8b00 51 03c2 50 e8???????? }
            // n = 6, score = 2300
            //   034c240c             | push                esi
            //   8b00                 | lea                 eax, [eax + edi - 1]
            //   51                   | dec                 edi
            //   03c2                 | not                 edi
            //   50                   | and                 eax, edi
            //   e8????????           |                     

        $sequence_6 = { 8b5608 8d5410ff 48 f7d0 }
            // n = 4, score = 2300
            //   8b5608               | mov                 ecx, dword ptr [eax + 8]
            //   8d5410ff             | jbe                 0xb
            //   48                   | mov                 eax, dword ptr [ecx + 0x3c]
            //   f7d0                 | lea                 edx, [eax + ebx - 1]

        $sequence_7 = { 0fb74106 8365f800 53 8945fc 0fb74114 56 }
            // n = 6, score = 2300
            //   0fb74106             | neg                 eax
            //   8365f800             | inc                 ebp
            //   53                   | sbb                 esi, esi
            //   8945fc               | lea                 ebp, [ebx + 4]
            //   0fb74114             | movzx               edx, word ptr [ecx + 0x128]
            //   56                   | cmp                 dx, 6

        $sequence_8 = { 8b4d10 8984b558feffff 57 8bc3 8d9568ffffff e8???????? }
            // n = 6, score = 1800
            //   8b4d10               | mov                 dword ptr [esp + 4], eax
            //   8984b558feffff       | mov                 ecx, 1
            //   57                   | lea                 edx, [0x253558]
            //   8bc3                 | mov                 esi, 0x14
            //   8d9568ffffff         | mov                 eax, dword ptr [ebp - 0x44]
            //   e8????????           |                     

        $sequence_9 = { 8bec 51 837d0804 53 56 }
            // n = 5, score = 1800
            //   8bec                 | mov                 dword ptr [ebp - 0x60], eax
            //   51                   | jmp                 5
            //   837d0804             | mov                 eax, dword ptr [ebp - 0x60]
            //   53                   | mov                 cl, byte ptr [eax]
            //   56                   | mov                 dword ptr [ebp - 0x100], eax

        $sequence_10 = { 8bd8 8bf9 8db5f0feffff 8bce }
            // n = 4, score = 1800
            //   8bd8                 | jne                 0xffffffd7
            //   8bf9                 | lea                 eax, [0x253424]
            //   8db5f0feffff         | xor                 ecx, ecx
            //   8bce                 | mov                 dword ptr [esp], eax

        $sequence_11 = { 885405fc 40 83f803 7ce4 }
            // n = 4, score = 1800
            //   885405fc             | lea                 esi, [ebp - 0x110]
            //   40                   | mov                 ecx, esi
            //   83f803               | lea                 esi, [eax + edi]
            //   7ce4                 | mov                 ebx, eax

        $sequence_12 = { 8d3438 e8???????? 8bd8 85db }
            // n = 4, score = 1800
            //   8d3438               | mov                 ecx, dword ptr [ebp - 0x14]
            //   e8????????           |                     
            //   8bd8                 | mov                 edx, dword ptr [ebp - 0x14]
            //   85db                 | cmp                 dword ptr [edx], 0x4550

        $sequence_13 = { 50 6a00 ffd7 8b45fc 85c0 }
            // n = 5, score = 1800
            //   50                   | push                ebx
            //   6a00                 | push                esi
            //   ffd7                 | push                edi
            //   8b45fc               | mov                 ebx, eax
            //   85c0                 | mov                 edi, ecx

        $sequence_14 = { 8bd8 85db 7420 8d45fc }
            // n = 4, score = 1800
            //   8bd8                 | cmove               eax, ecx
            //   85db                 | mov                 ecx, dword ptr [ebp + 0x10]
            //   7420                 | mov                 dword ptr [ebp + esi*4 - 0x1a8], eax
            //   8d45fc               | push                edi

        $sequence_15 = { 8bc3 8d8d68ffffff 8bd6 e8???????? 2907 833f00 }
            // n = 6, score = 1800
            //   8bc3                 | mov                 eax, ebx
            //   8d8d68ffffff         | lea                 edx, [ebp - 0x98]
            //   8bd6                 | mov                 ebp, esp
            //   e8????????           |                     
            //   2907                 | push                ecx
            //   833f00               | cmp                 dword ptr [ebp + 8], 4

        $sequence_16 = { 448b8424a8000000 488bd7 488bc8 e8???????? 8b9424a8000000 eb60 83a424a800000000 }
            // n = 7, score = 300
            //   448b8424a8000000     | dec                 eax
            //   488bd7               | test                edx, edx
            //   488bc8               | imul                eax, eax, 7
            //   e8????????           |                     
            //   8b9424a8000000       | sub                 ebx, eax
            //   eb60                 | add                 ebx, 3
            //   83a424a800000000     | inc                 esp

        $sequence_17 = { 6bc007 2bd8 83c303 e8???????? }
            // n = 4, score = 300
            //   6bc007               | dec                 eax
            //   2bd8                 | sub                 esp, 0x40
            //   83c303               | xor                 edi, edi
            //   e8????????           |                     

        $sequence_18 = { 33db 4533e4 48f7d8 451bf6 }
            // n = 4, score = 300
            //   33db                 | shr                 ecx, 0xc
            //   4533e4               | dec                 eax
            //   48f7d8               | xor                 ecx, edx
            //   451bf6               | dec                 eax

        $sequence_19 = { 8d6b04 0fb79128010000 6683fa06 7714 750a }
            // n = 5, score = 300
            //   8d6b04               | lea                 edx, [esp + 0x40]
            //   0fb79128010000       | dec                 eax
            //   6683fa06             | mov                 ecx, dword ptr [esp + 0x20]
            //   7714                 | dec                 eax
            //   750a                 | mov                 dword ptr [esi], ecx

        $sequence_20 = { 488b0d???????? 4c8bc7 33d2 ff15???????? 4c8b442478 488b0d???????? }
            // n = 6, score = 300
            //   488b0d????????       |                     
            //   4c8bc7               | dec                 eax
            //   33d2                 | mov                 ecx, edx
            //   ff15????????         |                     
            //   4c8b442478           | dec                 eax
            //   488b0d????????       |                     

        $sequence_21 = { 488b4c2420 48890e eb14 4c8b442420 488b0d???????? }
            // n = 5, score = 300
            //   488b4c2420           | mov                 ecx, eax
            //   48890e               | mov                 edx, dword ptr [esp + 0xa8]
            //   eb14                 | jmp                 0x62
            //   4c8b442420           | and                 dword ptr [esp + 0xa8], 0
            //   488b0d????????       |                     

        $sequence_22 = { 488bca 48c1e90c 4833ca 488d542440 }
            // n = 4, score = 300
            //   488bca               | mov                 eax, dword ptr [esp + 0xa8]
            //   48c1e90c             | dec                 eax
            //   4833ca               | mov                 edx, edi
            //   488d542440           | dec                 eax

        $sequence_23 = { 4155 4156 4157 4883ec40 33ff 4885d2 }
            // n = 6, score = 300
            //   4155                 | inc                 ecx
            //   4156                 | push                ebp
            //   4157                 | inc                 ecx
            //   4883ec40             | push                esi
            //   33ff                 | inc                 ecx
            //   4885d2               | push                edi

        $sequence_24 = { 8b45bc 8945a0 eb00 8b45a0 8a08 }
            // n = 5, score = 100
            //   8b45bc               | mov                 dword ptr [esp + 8], 0x14
            //   8945a0               | mov                 byte ptr [ebp - 0xaa], 0x4c
            //   eb00                 | push                edi
            //   8b45a0               | push                esi
            //   8a08                 | sub                 esp, 0x68

        $sequence_25 = { 83f800 8985d0fdffff 898dccfdffff 7463 8d051c318702 b90d000000 }
            // n = 6, score = 100
            //   83f800               | not                 edi
            //   8985d0fdffff         | and                 eax, edi
            //   898dccfdffff         | movzx               eax, word ptr [ecx + 6]
            //   7463                 | and                 dword ptr [ebp - 8], 0
            //   8d051c318702         | push                ebx
            //   b90d000000           | mov                 dword ptr [ebp - 4], eax

        $sequence_26 = { 898500ffffff 75d5 8d0524342500 31c9 890424 c744240400000000 }
            // n = 6, score = 100
            //   898500ffffff         | mov                 eax, dword ptr [ebp + 0xc]
            //   75d5                 | mov                 ecx, dword ptr [ebp + 8]
            //   8d0524342500         | xor                 edx, edx
            //   31c9                 | mov                 esi, dword ptr [ecx + 0x3c]
            //   890424               | add                 esi, 0x18
            //   c744240400000000     | cmp                 edi, 0x4550

        $sequence_27 = { c70001000000 0f2805???????? 8b8568ffffff 0f1100 8b8544ffffff c1e004 }
            // n = 6, score = 100
            //   c70001000000         | mov                 ebx, dword ptr [esi + 0x10]
            //   0f2805????????       |                     
            //   8b8568ffffff         | lea                 eax, [eax + edi - 1]
            //   0f1100               | lea                 ecx, [0x287311c]
            //   8b8544ffffff         | mov                 edx, 0xd
            //   c1e004               | mov                 esi, dword ptr [ebp - 0x2c0]

        $sequence_28 = { 890424 894c2404 e8???????? 8d0d84308702 }
            // n = 4, score = 100
            //   890424               | mov                 dword ptr [esp], esi
            //   894c2404             | mov                 dword ptr [esp + 4], ecx
            //   e8????????           |                     
            //   8d0d84308702         | push                0x3ff

        $sequence_29 = { 68ff030000 8b8dccfbffff 51 8bb5e0fbffff 56 8985c0fbffff ffd2 }
            // n = 7, score = 100
            //   68ff030000           | and                 edi, edx
            //   8b8dccfbffff         | cmp                 edi, eax
            //   51                   | mov                 eax, dword ptr [esi + 8]
            //   8bb5e0fbffff         | mov                 edx, dword ptr [ecx + 0x3c]
            //   56                   | mov                 ebx, dword ptr [esi + 0x10]
            //   8985c0fbffff         | lea                 eax, [eax + edi - 1]
            //   ffd2                 | dec                 edi

        $sequence_30 = { 8b4df0 894130 8b4154 890424 }
            // n = 4, score = 100
            //   8b4df0               | mov                 ecx, 0xd
            //   894130               | mov                 esi, dword ptr [ebp - 0x420]
            //   8b4154               | push                esi
            //   890424               | mov                 dword ptr [ebp - 0x440], eax

        $sequence_31 = { 83c618 81ff50450000 0f44d6 8b7580 81ff50450000 89c7 }
            // n = 6, score = 100
            //   83c618               | mov                 edx, dword ptr [ecx + 0x3c]
            //   81ff50450000         | and                 eax, edi
            //   0f44d6               | lea                 edi, [ebx + edx - 1]
            //   8b7580               | dec                 edx
            //   81ff50450000         | not                 edx
            //   89c7                 | and                 edi, edx

        $sequence_32 = { 8d0d1c318702 ba0d000000 8bb540fdffff 893424 894c2404 }
            // n = 5, score = 100
            //   8d0d1c318702         | not                 edi
            //   ba0d000000           | and                 eax, edi
            //   8bb540fdffff         | lea                 edi, [ebx + edx - 1]
            //   893424               | dec                 edx
            //   894c2404             | not                 edx

        $sequence_33 = { 89f8 c1e81f c1ef1d 83e701 898540ffffff 8b856cffffff }
            // n = 6, score = 100
            //   89f8                 | mov                 ecx, dword ptr [ebp - 0x434]
            //   c1e81f               | push                ecx
            //   c1ef1d               | mov                 esi, dword ptr [ebp - 0x420]
            //   83e701               | push                esi
            //   898540ffffff         | mov                 dword ptr [ebp - 0x440], eax
            //   8b856cffffff         | call                edx

        $sequence_34 = { 897e08 8b9d68fdffff 891e c7460cfe308702 c74604???????? 8b35???????? 898560fdffff }
            // n = 7, score = 100
            //   897e08               | cmp                 eax, 0
            //   8b9d68fdffff         | mov                 dword ptr [ebp - 0x230], eax
            //   891e                 | mov                 dword ptr [ebp - 0x234], ecx
            //   c7460cfe308702       | je                  0x74
            //   c74604????????       |                     
            //   8b35????????         |                     
            //   898560fdffff         | lea                 eax, [0x287311c]

        $sequence_35 = { 8b8d34ffffff 894c2404 c744240814000000 e8???????? c68556ffffff4c }
            // n = 5, score = 100
            //   8b8d34ffffff         | dec                 eax
            //   894c2404             | not                 eax
            //   c744240814000000     | and                 edx, eax
            //   e8????????           |                     
            //   c68556ffffff4c       | mov                 eax, dword ptr [esi + 0xc]

        $sequence_36 = { 8855ef 8945e8 8b45e8 8b4df0 8a55ef 881401 }
            // n = 6, score = 100
            //   8855ef               | cmove               edx, esi
            //   8945e8               | mov                 esi, dword ptr [ebp - 0x80]
            //   8b45e8               | cmp                 edi, 0x4550
            //   8b4df0               | mov                 edi, eax
            //   8a55ef               | cmove               esi, edx
            //   881401               | mov                 ecx, dword ptr [esi]

        $sequence_37 = { 8b853cffffff 89442404 e8???????? b901000000 8d1558352500 be14000000 }
            // n = 6, score = 100
            //   8b853cffffff         | cmp                 eax, dword ptr [esi + 0xc]
            //   89442404             | jb                  0x54
            //   e8????????           |                     
            //   b901000000           | mov                 edi, dword ptr [ecx + 0x38]
            //   8d1558352500         | mov                 ecx, dword ptr [ebp - 0xcc]
            //   be14000000           | mov                 dword ptr [esp + 4], ecx

        $sequence_38 = { 0f44f2 8b0e 83f900 8955c4 8975c0 }
            // n = 5, score = 100
            //   0f44f2               | cmp                 edi, eax
            //   8b0e                 | push                esi
            //   83f900               | push                edi
            //   8955c4               | lea                 esi, [eax + ecx + 0x18]
            //   8975c0               | mov                 eax, dword ptr [ebp + 8]

        $sequence_39 = { 57 56 83ec68 8b450c 8b4d08 31d2 8b713c }
            // n = 7, score = 100
            //   57                   | add                 eax, edx
            //   56                   | cmp                 dword ptr [ebp + 8], eax
            //   83ec68               | mov                 eax, dword ptr [ebp + 8]
            //   8b450c               | cmp                 eax, dword ptr [esi + 0xc]
            //   8b4d08               | jb                  0x5c
            //   31d2                 | mov                 edi, dword ptr [ecx + 0x38]
            //   8b713c               | mov                 eax, dword ptr [esi + 8]

    condition:
        7 of them and filesize < 221184
}