rule win_calmthorn_auto {

    meta:
        author = "Felix Bilstein - yara-signator at cocacoding dot com"
        date = "2023-03-28"
        version = "1"
        description = "Detects win.calmthorn."
        info = "autogenerated rule brought to you by yara-signator"
        tool = "yara-signator v0.6.0"
        signator_config = "callsandjumps;datarefs;binvalue"
        malpedia_reference = "https://malpedia.caad.fkie.fraunhofer.de/details/win.calmthorn"
        malpedia_rule_date = "20230328"
        malpedia_hash = "9d2d75cef573c1c2d861f5197df8f563b05a305d"
        malpedia_version = "20230407"
        malpedia_license = "CC BY-SA 4.0"
        malpedia_sharing = "TLP:WHITE"

    /* DISCLAIMER
     * The strings used in this rule have been automatically selected from the
     * disassembly of memory dumps and unpacked files, using YARA-Signator.
     * The code and documentation is published here:
     * https://github.com/fxb-cocacoding/yara-signator
     * As Malpedia is used as data source, please note that for a given
     * number of families, only single samples are documented.
     * This likely impacts the degree of generalization these rules will offer.
     * Take the described generation method also into consideration when you
     * apply the rules in your use cases and assign them confidence levels.
     */


    strings:
        $sequence_0 = { 8b95c0d5ffff 0fbe02 85c0 7502 eb02 ebba 0fb68d21fdffff }
            // n = 7, score = 100
            //   8b95c0d5ffff         | mov                 edx, dword ptr [ebp - 0x2a40]
            //   0fbe02               | movsx               eax, byte ptr [edx]
            //   85c0                 | test                eax, eax
            //   7502                 | jne                 4
            //   eb02                 | jmp                 4
            //   ebba                 | jmp                 0xffffffbc
            //   0fb68d21fdffff       | movzx               ecx, byte ptr [ebp - 0x2df]

        $sequence_1 = { 8b959c17ffff 83c201 8b85a017ffff 83d000 89959c17ffff 8985a017ffff 83bda017ffffff }
            // n = 7, score = 100
            //   8b959c17ffff         | mov                 edx, dword ptr [ebp - 0xe864]
            //   83c201               | add                 edx, 1
            //   8b85a017ffff         | mov                 eax, dword ptr [ebp - 0xe860]
            //   83d000               | adc                 eax, 0
            //   89959c17ffff         | mov                 dword ptr [ebp - 0xe864], edx
            //   8985a017ffff         | mov                 dword ptr [ebp - 0xe860], eax
            //   83bda017ffffff       | cmp                 dword ptr [ebp - 0xe860], -1

        $sequence_2 = { ff7590 ff15???????? b801000000 5f 5e 5b 8b4dfc }
            // n = 7, score = 100
            //   ff7590               | push                dword ptr [ebp - 0x70]
            //   ff15????????         |                     
            //   b801000000           | mov                 eax, 1
            //   5f                   | pop                 edi
            //   5e                   | pop                 esi
            //   5b                   | pop                 ebx
            //   8b4dfc               | mov                 ecx, dword ptr [ebp - 4]

        $sequence_3 = { 8b8df405ffff 83c101 8b95f805ffff 83d200 898df405ffff 8995f805ffff 83bdf805ffff00 }
            // n = 7, score = 100
            //   8b8df405ffff         | mov                 ecx, dword ptr [ebp - 0xfa0c]
            //   83c101               | add                 ecx, 1
            //   8b95f805ffff         | mov                 edx, dword ptr [ebp - 0xfa08]
            //   83d200               | adc                 edx, 0
            //   898df405ffff         | mov                 dword ptr [ebp - 0xfa0c], ecx
            //   8995f805ffff         | mov                 dword ptr [ebp - 0xfa08], edx
            //   83bdf805ffff00       | cmp                 dword ptr [ebp - 0xfa08], 0

        $sequence_4 = { eb0f 8b9500a2ffff 83c201 899500a2ffff 8b85e8e3ffff 50 e8???????? }
            // n = 7, score = 100
            //   eb0f                 | jmp                 0x11
            //   8b9500a2ffff         | mov                 edx, dword ptr [ebp - 0x5e00]
            //   83c201               | add                 edx, 1
            //   899500a2ffff         | mov                 dword ptr [ebp - 0x5e00], edx
            //   8b85e8e3ffff         | mov                 eax, dword ptr [ebp - 0x1c18]
            //   50                   | push                eax
            //   e8????????           |                     

        $sequence_5 = { 8b957009ffff 83d200 898d6c09ffff 89957009ffff 83bd7009ffff00 771f 720c }
            // n = 7, score = 100
            //   8b957009ffff         | mov                 edx, dword ptr [ebp - 0xf690]
            //   83d200               | adc                 edx, 0
            //   898d6c09ffff         | mov                 dword ptr [ebp - 0xf694], ecx
            //   89957009ffff         | mov                 dword ptr [ebp - 0xf690], edx
            //   83bd7009ffff00       | cmp                 dword ptr [ebp - 0xf690], 0
            //   771f                 | ja                  0x21
            //   720c                 | jb                  0xe

        $sequence_6 = { ebba 0fb69521fdffff 83fa01 7553 0f57c0 660f13857431ffff eb1e }
            // n = 7, score = 100
            //   ebba                 | jmp                 0xffffffbc
            //   0fb69521fdffff       | movzx               edx, byte ptr [ebp - 0x2df]
            //   83fa01               | cmp                 edx, 1
            //   7553                 | jne                 0x55
            //   0f57c0               | xorps               xmm0, xmm0
            //   660f13857431ffff     | movlpd              qword ptr [ebp - 0xce8c], xmm0
            //   eb1e                 | jmp                 0x20

        $sequence_7 = { ebba 0fb69513fdffff 83fa01 7552 c78590a7ffff00000000 eb0f 8b8590a7ffff }
            // n = 7, score = 100
            //   ebba                 | jmp                 0xffffffbc
            //   0fb69513fdffff       | movzx               edx, byte ptr [ebp - 0x2ed]
            //   83fa01               | cmp                 edx, 1
            //   7552                 | jne                 0x54
            //   c78590a7ffff00000000     | mov    dword ptr [ebp - 0x5870], 0
            //   eb0f                 | jmp                 0x11
            //   8b8590a7ffff         | mov                 eax, dword ptr [ebp - 0x5870]

        $sequence_8 = { eb02 ebba 0fb68d13fdffff 83f901 7553 0f57c0 660f1385a40fffff }
            // n = 7, score = 100
            //   eb02                 | jmp                 4
            //   ebba                 | jmp                 0xffffffbc
            //   0fb68d13fdffff       | movzx               ecx, byte ptr [ebp - 0x2ed]
            //   83f901               | cmp                 ecx, 1
            //   7553                 | jne                 0x55
            //   0f57c0               | xorps               xmm0, xmm0
            //   660f1385a40fffff     | movlpd              qword ptr [ebp - 0xf05c], xmm0

        $sequence_9 = { ebba 0fb68568fdffff 83f801 7552 c78538e2ffff00000000 eb0f 8b8d38e2ffff }
            // n = 7, score = 100
            //   ebba                 | jmp                 0xffffffbc
            //   0fb68568fdffff       | movzx               eax, byte ptr [ebp - 0x298]
            //   83f801               | cmp                 eax, 1
            //   7552                 | jne                 0x54
            //   c78538e2ffff00000000     | mov    dword ptr [ebp - 0x1dc8], 0
            //   eb0f                 | jmp                 0x11
            //   8b8d38e2ffff         | mov                 ecx, dword ptr [ebp - 0x1dc8]

    condition:
        7 of them and filesize < 2322432
}