rule win_payloadbin_auto {

    meta:
        author = "Felix Bilstein - yara-signator at cocacoding dot com"
        date = "2023-03-28"
        version = "1"
        description = "Detects win.payloadbin."
        info = "autogenerated rule brought to you by yara-signator"
        tool = "yara-signator v0.6.0"
        signator_config = "callsandjumps;datarefs;binvalue"
        malpedia_reference = "https://malpedia.caad.fkie.fraunhofer.de/details/win.payloadbin"
        malpedia_rule_date = "20230328"
        malpedia_hash = "9d2d75cef573c1c2d861f5197df8f563b05a305d"
        malpedia_version = "20230407"
        malpedia_license = "CC BY-SA 4.0"
        malpedia_sharing = "TLP:WHITE"

    /* DISCLAIMER
     * The strings used in this rule have been automatically selected from the
     * disassembly of memory dumps and unpacked files, using YARA-Signator.
     * The code and documentation is published here:
     * https://github.com/fxb-cocacoding/yara-signator
     * As Malpedia is used as data source, please note that for a given
     * number of families, only single samples are documented.
     * This likely impacts the degree of generalization these rules will offer.
     * Take the described generation method also into consideration when you
     * apply the rules in your use cases and assign them confidence levels.
     */


    strings:
        $sequence_0 = { 5d 5d 415e 415a 9d 415a c3 }
            // n = 7, score = 100
            //   5d                   | xor                 byte ptr [esp + ecx - 0x6fcc0647], cl
            //   5d                   | inc                 ecx
            //   415e                 | pop                 ecx
            //   415a                 | popfd               
            //   9d                   | inc                 ecx
            //   415a                 | pop                 ecx
            //   c3                   | push                ebx

        $sequence_1 = { 415d 5a 415d 5d 415d 9d }
            // n = 6, score = 100
            //   415d                 | inc                 cx
            //   5a                   | bt                  eax, eax
            //   415d                 | inc                 ecx
            //   5d                   | neg                 al
            //   415d                 | dec                 esp
            //   9d                   | mov                 eax, dword ptr [esp + 0x128]

        $sequence_2 = { cd55 50 9c 48b83f1ded1aa11bbb1b 68764f2f3e e8???????? 9d }
            // n = 7, score = 100
            //   cd55                 | inc                 ecx
            //   50                   | push                ebp
            //   9c                   | inc                 eax
            //   48b83f1ded1aa11bbb1b     | rcr    bh, cl
            //   68764f2f3e           | cwde                
            //   e8????????           |                     
            //   9d                   | inc                 ecx

        $sequence_3 = { 9c e8???????? c1bc2418000000c0 81842418000000ab1a571b 48c7442418480962db }
            // n = 5, score = 100
            //   9c                   | btr                 bp, 0xf9
            //   e8????????           |                     
            //   c1bc2418000000c0     | inc                 eax
            //   81842418000000ab1a571b     | inc    ch
            //   48c7442418480962db     | dec    eax

        $sequence_4 = { 488bcb e9???????? e8???????? 488bf0 493bc7 e9???????? 0f840d000000 }
            // n = 7, score = 100
            //   488bcb               | push                edx
            //   e9????????           |                     
            //   e8????????           |                     
            //   488bf0               | dec                 eax
            //   493bc7               | add                 dword ptr [esp + 0x10], 0x6de360f0
            //   e9????????           |                     
            //   0f840d000000         | inc                 ecx

        $sequence_5 = { 0f841c000000 413bc6 0f8313000000 ffc0 f5 413ae9 d1e9 }
            // n = 7, score = 100
            //   0f841c000000         | jp                  0x151
            //   413bc6               | mov                 al, 0x51
            //   0f8313000000         | inc                 ecx
            //   ffc0                 | dec                 eax
            //   f5                   | adc                 eax, 0x59071423
            //   413ae9               | btr                 ax, 0xeb
            //   d1e9                 | shl                 al, cl

        $sequence_6 = { 84c0 0f8453000000 488d442430 49c1d159 f9 33d2 664587c9 }
            // n = 7, score = 100
            //   84c0                 | add                 ecx, eax
            //   0f8453000000         | dec                 ecx
            //   488d442430           | movzx               esi, si
            //   49c1d159             | inc                 ecx
            //   f9                   | mov                 esi, edi
            //   33d2                 | dec                 eax
            //   664587c9             | lea                 edx, [esp + 0x78]

        $sequence_7 = { 6861350314 858c2400000000 6830594160 415b 68fe55251f 664585f3 681d01437b }
            // n = 7, score = 100
            //   6861350314           | je                  0x8d1
            //   858c2400000000       | dec                 esp
            //   6830594160           | lea                 eax, [esp + 0x40]
            //   415b                 | dec                 eax
            //   68fe55251f           | mov                 ecx, esi
            //   664585f3             | test                al, al
            //   681d01437b           | je                  0x77e

        $sequence_8 = { 4032f8 4881ec80000000 488bf9 4963f1 488d4c2420 490fb7f0 408ade }
            // n = 7, score = 100
            //   4032f8               | jge                 0xf29
            //   4881ec80000000       | mov                 ecx, eax
            //   488bf9               | mov                 ebx, eax
            //   4963f1               | jge                 0xf36
            //   488d4c2420           | mov                 ecx, eax
            //   490fb7f0             | mov                 ebx, eax
            //   408ade               | jle                 0xf40

        $sequence_9 = { 9d 488d642408 e8???????? 4881842410000000df154443 415d 415d 488d642408 }
            // n = 7, score = 100
            //   9d                   | mov                 ecx, ebx
            //   488d642408           | inc                 ecx
            //   e8????????           |                     
            //   4881842410000000df154443     | shr    al, 0xa0
            //   415d                 | inc                 ebp
            //   415d                 | sub                 al, ch
            //   488d642408           | inc                 ecx

    condition:
        7 of them and filesize < 3761152
}